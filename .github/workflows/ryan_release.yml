name: Build & Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      versionL: ${{ steps.ver.outputs.versionL }}
      is_release: ${{ steps.ver.outputs.is_release }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      #
      # 获取该 commit 关联的 PR 标题（如果是 merge commit）
      #
      - name: Detect PR Title
        id: pr
        run: |
          PR_TITLE=$(gh api repos/${{ github.repository }}/commits/${{ github.sha }}/pulls --jq ".[0].title" || echo "")
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #
      # 根据 PR 前缀 / 时间戳生成版本号 & 是否 release
      #
      - name: Set Version
        id: ver
        run: |
          PROPERTIES=app/version.properties
          MAJOR=$(grep VERSION_MAJOR $PROPERTIES | cut -d= -f2)
          MINOR=$(grep VERSION_MINOR $PROPERTIES | cut -d= -f2)
          PATCH=$(grep VERSION_PATCH $PROPERTIES | cut -d= -f2)
          BASE="$MAJOR.$MINOR.$PATCH"

          PR_TITLE="${{ steps.pr.outputs.pr_title }}"

          # 1) 如果 PR 标题以 release: 开头 → 正式版
          if [[ "$PR_TITLE" == release:* ]]; then
            VERSION="$BASE"
            echo "versionL=$VERSION" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2) 否则为 preview 版（main push）
          TS=$(date +"%Y%m%d%H%M")
          VERSION="$BASE-preview.$TS"
          echo "versionL=$VERSION" >> $GITHUB_OUTPUT
          echo "is_release=false" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  build:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      VER: ${{ needs.prepare.outputs.versionL }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 17

      - name: Apply version to Gradle
        run: |
          sed -i "s/ext.versionName = .*/ext.versionName = \"$VER\"/" app/build.gradle

      - name: Decode signing key
        run: |
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > app/my-release-key.jks
          {
            echo "RELEASE_STORE_FILE=my-release-key.jks"
            echo "RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}"
            echo "RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }}"
            echo "RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}"
          } >> gradle.properties

      - uses: gradle/actions/setup-gradle@v4

      - name: Build APK
        run: |
          chmod +x gradlew
          ./gradlew assembleAppRelease

      - uses: actions/upload-artifact@v4
        with:
          name: apk
          path: app/build/outputs/apk/app/release/*.apk


  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Collect commits since last tag
        id: log
        run: |
          LAST=$(git describe --tags --abbrev=0 --always 2>/dev/null || echo "")
          LOG=$(git log $LAST..HEAD --pretty=format:"* %s" --no-merges)
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "### Changes" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: apk
          path: dist

      - name: Rename APK
        run: |
          V="${{ needs.prepare.outputs.versionL }}"
          cd dist
          for f in *.apk; do
            case "$f" in
              *arm64-v8a*) mv "$f" "legado-$V-arm64-v8a.apk" ;;
              *armeabi-v7a*) mv "$f" "legado-$V-armeabi-v7a.apk" ;;
              *) mv "$f" "legado-$V.apk" ;;
            esac
          done

      #
      # 正式版：自动创建 tag
      #
      - name: Create tag for release
        if: needs.prepare.outputs.is_release == 'true'
        run: |
          git tag ${{ needs.prepare.outputs.versionL }}
          git push origin ${{ needs.prepare.outputs.versionL }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.versionL }}
          name: ${{ needs.prepare.outputs.is_release == 'true' && format('Release {0}', needs.prepare.outputs.versionL) || format('Preview {0}', needs.prepare.outputs.versionL) }}
          body: ${{ steps.log.outputs.body }}
          prerelease: ${{ needs.prepare.outputs.is_release == 'true' && 'false' || 'true' }}
          files: dist/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}